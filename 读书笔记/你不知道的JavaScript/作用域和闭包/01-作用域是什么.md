# 作用域是什么

## 编译原理

JavaScript事实上是一门编译语言，归类为动态、解释执行语言

传统编译语言执行步骤：

- 分词/语法分析
- 解析/语法分析
- 代码生成

JavaScript：

JavaScript的编译过程和其它语言不一样，不是发生在构建之前的，大部分情况下编译发送在代码执行之前一点

## 理解作用域

JavaScript执行过程中的几个流程：

- 引擎：负责整个JavaScript程序的编译和执行过程
- 编译器：负责语法分析及代码生成等
- 作用域：负责手机并维护所有声明的标识符(变量)组成的一系列查询，并有一整套严格的规则，确定当前执行代码对这些标识符的访问权限

```javascript
var a = 2
```

简单理解编译器生成的代码含义：

- 为一个变量分配内存，将其命名为a
- 将值2保存进这个变量

实际编译器的处理过程：

- 遇到var a，编译器先询问当前作用域下是否有一个该名称的变量
- 如果是，编译器忽略该声明，继续进行编译；否则会在当前作用域集合中声明一个新的变量，命名为a
- 下面，编译器会为引擎生成运行时代码，代码用来处理a = 2这个赋值操作
- 引擎会先问当前作用域是否存在一个叫a的变量，如果有，使用这个变量，如果没有，会继续向上查找该变量
- 如果找到了，进行赋值，如果没找到，抛出错误

总结为：

- 编译器在当前作用域声明一个变量
- 运行时，引擎在作用域中查找改变量，找到了就进行赋值

### 编译器有话说

编译器查询分为两种类型：LHS和RHS

LHS: 本质就是对变量进行赋值

RHS: 本质就是获取变量的值

```javascript
function foo(a) {
  console.log(a)
}
foo(2)
```

引擎：在作用域查找foo，进行RHS引用

作用域：我这里有foo

引擎：执行foo

引擎：我要对a进行LHS引用

作用域：编译器把a声明为foo的形参了

引擎：把2赋值给a

引擎：我要对console进行RHS引用

作用域：console是内置对象

引擎：我要看看console里面是不是有一个log

引擎：帮我再找一下对a的RHS引用

作用域：这个变量没动过

引擎：把a的值，也就是2传给log

## 作用域嵌套

作用域的查找规则：

1. 先在当前作用域查找变量
2. 如果找到，直接使用，如果没找到，在外层嵌套作用域中继续查找
3. 如果外层作用域还是没找到，继续向上查找，知道最外层作用域
4. 查找到最外层作用域后，不管是否找到变量，都会停止查找

### 作用域链

这个建筑代表程序中的嵌套作用域链。第一层楼代表当前的执行作用域，也就是你所处的 

位置。建筑的顶层代表全局作用域



## 异常

ReferenceError：

RHS 查询在所有嵌套的作用域中遍寻不到所需的变量，引擎就会抛出 ReferenceError 异常

当引擎执行 LHS 查询时，如果在顶层（全局作用域）中也无法找到目标变量， 

全局作用域中就会创建一个具有该名称的变量，并将其返还给引擎

TypeError：

如果RHS查找到了一个变量，但是对变量值进行不合理操作时，如null、undefined进行属性取值，会报TypeError错误

## 小结

如果查找的目的是对变量进行赋值，那么就会使用LHS查询

如果是为了取变量的值，就会使用RHS查询

